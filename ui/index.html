<!DOCTYPE html>
<html lang="en">
  <head>
    <title>K-Web 0.1</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2285%22>üåê</text></svg>">
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style type="text/css">
      html, body { margin: 0; padding: 0;}
      #info {
        position: fixed;
        bottom: 0;
        left: 0;
        z-index: 10;
        padding: 5px;
      }
      #mynetwork {
        width: 66vw;
        height: 100vh;
      }
      #content {
        position: absolute;
        top: 0;
        right: 0;
        width: 33vw;
        height: 100vh;
        overflow: scroll;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div id="info"><a href="/info">What is this?</a></div>
    <div id="mynetwork"></div>
    <div id="content"></div>
    <script type="text/javascript">
      const { marked } = window

      marked.setOptions({
        // renderer: new marked.Renderer(),
        // highlight: function(code, lang) {
        //   const hljs = require('highlight.js');
        //   const language = hljs.getLanguage(lang) ? lang : 'plaintext';
        //   return hljs.highlight(code, { language }).value;
        // },
        // langPrefix: 'hljs language-', // highlight.js css expects a top-level 'hljs' class.
        // pedantic: false,
        gfm: true,
        breaks: true,
        // sanitize: false,
        // smartypants: false,
        // xhtml: false
      })

      // const MODE = 'local' // TODO make 'external' work
      // const apiUrl =  MODE === 'local' ? '/api/v0' : 'https://k-web.ismandatory.com/api/v0'
      const apiUrl = 'http://localhost:7575/api/v0'

      function contentToHtml (content, id = '') {
        let html = ''
        if (content.md) {
          const md = content.md.replaceAll('.data/md-images/', `/data/${id}/.data/md-images/`)
          html = marked.parse(md)
        } else if (content.html) {
          html = content.html
        }
        return html
      }

      async function fetchNode (x = '') {
        const res = await fetch(`${apiUrl}/nodes/${x}`)
        let { nodes, links, id } = await res.json() // id = current node id / selected (if x is empty)
        
        const content = contentToHtml(nodes[id].content, id)
        document.getElementById('content').innerHTML = content

        // return { nodes, links } // TODO return here instead!
        
        nodes = Object.values(nodes) // XXX adjust to vis.js format
        nodes.map(node => { node.label = node.name })
        return { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(links) }
      }

      async function load(id = '') {
        const { nodes, edges } = await fetchNode(id)

        // create a network
        var container = document.getElementById('mynetwork')
        var data = { nodes, edges }
        const options = {
          nodes: {
            margin: 100
          }
        }
        var network = new vis.Network(container, data, options)

        // TODO more events... see https://visjs.github.io/vis-network/docs/network/#Events
        network.on('selectNode', async function (params) {
          const id = params.nodes[0]
          const { nodes, edges } = await fetchNode(id)
          network.setData({ nodes, edges })

          // params.event = "[original event]";
          // document.getElementById("eventSpan").innerHTML =
          //   "<h2>Click event:</h2>" + JSON.stringify(params, null, 4);
          // console.log(
          //   "click event, getNodeAt returns: " + this.getNodeAt(params.pointer.DOM)
          // );
        })
      }

      async function main () {
        load()
      }
      
      main()
    </script>
  </body>
</html>